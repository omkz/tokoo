<div class="max-w-4xl mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-8">Complete Payment</h1>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
    <!-- Payment Method Selection -->
    <div class="bg-white p-6 rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-4">Select Payment Method</h2>

      <%= form_with url: process_payment_checkout_path(@order), method: :post, id: "payment-form", data: { turbo: false } do |f| %>
        <div class="space-y-4 mb-6">
          <% @payment_methods.each do |method| %>
            <div class="flex items-center p-4 border rounded-lg hover:bg-gray-50 transition-colors">
              <%= radio_button_tag "payment_method_id", method.id, method.code == 'stripe_cc',
                  class: "h-4 w-4 text-indigo-600",
                  data: { payment_method: method.code },
                  id: "payment_method_#{method.id}" %>
              <%= label_tag "payment_method_#{method.id}", class: "ml-3 flex-1 cursor-pointer" do %>
                <span class="font-medium text-gray-900"><%= method.name %></span>
                <% if method.description.present? %>
                  <p class="text-sm text-gray-500 mt-1"><%= method.description %></p>
                <% end %>
              <% end %>
            </div>
          <% end %>
        </div>

        <!-- Stripe Elements Container -->
        <div id="stripe-card-element" class="hidden mb-4">
          <div class="p-4 border border-gray-300 rounded-lg bg-gray-50">
            <label class="block text-sm font-medium text-gray-700 mb-2">Card Details</label>
            <div id="card-element" class="p-3 bg-white border border-gray-300 rounded"></div>
            <div id="card-errors" class="text-red-600 text-sm mt-2" role="alert"></div>
          </div>
        </div>

        <div class="flex justify-between items-center pt-4 border-t">
          <p class="text-lg font-bold text-gray-900">Total: <%= number_to_currency(@order.total) %></p>
          <%= f.submit "Pay Now",
              class: "px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium transition-colors",
              id: "submit-button" %>
        </div>
      <% end %>
    </div>

    <!-- Order Summary -->
    <div class="bg-white p-6 rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-4">Order Summary</h2>
      <p class="text-sm text-gray-600 mb-4">Order #<%= @order.order_number %></p>

      <div class="space-y-3 mb-6">
        <% @order.order_items.each do |item| %>
          <div class="flex justify-between text-sm">
            <span class="text-gray-700">
              <%= item.product_name %>
              <% if item.variant_name.present? %>
                <span class="text-gray-500">(<%= item.variant_name %>)</span>
              <% end %>
              <span class="text-gray-500">x<%= item.quantity %></span>
            </span>
            <span class="text-gray-900"><%= number_to_currency(item.total_price) %></span>
          </div>
        <% end %>
      </div>

      <div class="space-y-2 pt-4 border-t">
        <div class="flex justify-between text-sm">
          <span class="text-gray-600">Subtotal</span>
          <span class="text-gray-900"><%= number_to_currency(@order.subtotal) %></span>
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-gray-600">Shipping</span>
          <span class="text-gray-900"><%= number_to_currency(@order.shipping_cost) %></span>
        </div>
        <% if @order.tax_amount > 0 %>
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Tax</span>
            <span class="text-gray-900"><%= number_to_currency(@order.tax_amount) %></span>
          </div>
        <% end %>
        <div class="flex justify-between font-bold text-lg pt-2 border-t">
          <span class="text-gray-900">Total</span>
          <span class="text-gray-900"><%= number_to_currency(@order.total) %></span>
        </div>
      </div>
    </div>
  </div>
</div>

<% if @stripe_publishable_key.present? %>
  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    const stripe = Stripe('<%= @stripe_publishable_key %>');
    const elements = stripe.elements();

    let cardElement = null;
    let isStripeSelected = false;

    // Initialize Stripe Elements when Stripe payment method is selected
    function initializeStripe() {
      if (!cardElement && isStripeSelected) {
        cardElement = elements.create('card', {
          style: {
            base: {
              fontSize: '16px',
              color: '#424770',
              '::placeholder': {
                color: '#aab7c4',
              },
            },
            invalid: {
              color: '#9e2146',
            },
          },
        });

        cardElement.mount('#card-element');

        cardElement.on('change', ({error}) => {
          const displayError = document.getElementById('card-errors');
          if (error) {
            displayError.textContent = error.message;
          } else {
            displayError.textContent = '';
          }
        });
      }
    }

    // Show/hide Stripe form based on payment method
    document.querySelectorAll('input[name="payment_method_id"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const stripeContainer = document.getElementById('stripe-card-element');
        isStripeSelected = this.dataset.paymentMethod === 'stripe_cc';

        if (isStripeSelected) {
          stripeContainer.classList.remove('hidden');
          initializeStripe();
        } else {
          stripeContainer.classList.add('hidden');
        }
      });
    });

    // Initialize if Stripe is pre-selected
    const stripeRadio = document.querySelector('input[data-payment-method="stripe_cc"]');
    if (stripeRadio && stripeRadio.checked) {
      isStripeSelected = true;
      initializeStripe();
    }

    // Handle form submission
    const form = document.getElementById('payment-form');
    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      const submitButton = document.getElementById('submit-button');
      submitButton.disabled = true;
      submitButton.textContent = 'Processing...';

      const paymentMethodId = document.querySelector('input[name="payment_method_id"]:checked').value;
      const paymentMethodCode = document.querySelector('input[name="payment_method_id"]:checked').dataset.paymentMethod;

      if (paymentMethodCode === 'stripe_cc') {
        try {
          // First, create payment intent if not exists
          let clientSecret = '<%= @client_secret %>';

          if (!clientSecret || clientSecret === '') {
            // Create payment intent
            const paymentMethodId = document.querySelector('input[name="payment_method_id"]:checked').value;
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                             document.querySelector('input[name="authenticity_token"]')?.value;

            if (!csrfToken) {
              throw new Error('CSRF token not found');
            }

            // Use URLSearchParams for form data
            const formData = new URLSearchParams();
            formData.append('payment_method_id', paymentMethodId);
            formData.append('authenticity_token', csrfToken);

            const response = await fetch(form.action, {
              method: 'POST',
              body: formData,
              headers: {
                'X-CSRF-Token': csrfToken,
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
              },
              credentials: 'same-origin'
            });

            if (!response.ok) {
              let errorMessage = `Payment initialization failed: ${response.status}`;
              try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorMessage;
              } catch (e) {
                const errorText = await response.text();
                errorMessage = errorText || errorMessage;
              }
              throw new Error(errorMessage);
            }

            const result = await response.json();

            if (!result.success) {
              throw new Error(result.error || 'Failed to initialize payment');
            }

            clientSecret = result.client_secret;

            // Initialize card element if not already done
            if (!cardElement) {
              initializeStripe();
            }
          }

          // Confirm payment with Stripe
          const {error, paymentIntent} = await stripe.confirmCardPayment(clientSecret, {
            payment_method: {
              card: cardElement,
              billing_details: {
                name: '<%= @order.customer_name %>',
                email: '<%= @order.customer_email %>'
              }
            }
          });

          if (error) {
            console.error('Stripe error:', error);
            document.getElementById('card-errors').textContent = error.message;
            submitButton.disabled = false;
            submitButton.textContent = 'Pay Now';
          } else {
            console.log('Payment succeeded:', paymentIntent);
            // Payment succeeded, redirect to order confirmation
            window.location.href = '<%= checkout_path(@order) %>';
          }
        } catch (error) {
          console.error('Submission error:', error);
          document.getElementById('card-errors').textContent = error.message;
          submitButton.disabled = false;
          submitButton.textContent = 'Pay Now';
        }
      } else {
        // For non-Stripe methods, just submit the form
        form.submit();
      }
    });
  </script>
<% end %>

