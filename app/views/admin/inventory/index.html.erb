<% content_for :title, "Inventory Management" %>

<div class="glass-card p-8">
  <div class="flex justify-between items-center mb-8">
    <div>
      <h3 class="text-xl font-bold">Inventory Management</h3>
      <p class="text-sm text-slate-500">Track and manage stock levels across all products</p>
    </div>
    <div class="flex space-x-3">
      <%= link_to low_stock_admin_inventory_index_path, class: "px-4 py-2 bg-amber-100 text-amber-700 rounded-xl font-semibold hover:bg-amber-200 transition flex items-center" do %>
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
        Low Stock Alerts
      <% end %>
      <%= link_to history_admin_inventory_index_path, class: "px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-semibold hover:bg-slate-200 transition flex items-center" do %>
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        Movement History
      <% end %>
    </div>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full text-left">
      <thead>
        <tr class="text-slate-400 text-xs font-bold uppercase tracking-widest border-b border-slate-100">
          <th class="pb-4 px-4">Product</th>
          <th class="pb-4 px-4">SKU</th>
          <th class="pb-4 px-4 text-center">Stock</th>
          <th class="pb-4 px-4 text-center">Threshold</th>
          <th class="pb-4 px-4 text-center">Status</th>
          <th class="pb-4 px-4 text-center">Variants</th>
          <th class="pb-4 px-4 text-right">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-50">
        <% @products.each do |product| %>
          <tr class="group hover:bg-slate-50 transition">
            <td class="py-4 px-4">
              <div class="font-bold text-slate-800"><%= product.name %></div>
              <% if product.product_variants.any? %>
                <div class="text-xs text-slate-500 mt-1"><%= product.product_variants.count %> variants</div>
              <% end %>
            </td>
            <td class="py-4 px-4">
              <span class="text-sm text-slate-600 font-mono"><%= product.sku %></span>
            </td>
            <td class="py-4 px-4 text-center">
              <div class="flex items-center justify-center">
                <div class="w-2 h-2 rounded-full mr-2 <%= product.out_of_stock? ? 'bg-red-500' : (product.low_stock? ? 'bg-amber-500' : 'bg-emerald-500') %>"></div>
                <span class="text-sm font-bold <%= product.out_of_stock? ? 'text-red-600' : (product.low_stock? ? 'text-amber-600' : 'text-emerald-600') %>">
                  <%= product.stock_quantity %>
                </span>
              </div>
            </td>
            <td class="py-4 px-4 text-center">
              <span class="text-sm text-slate-500"><%= product.low_stock_threshold %></span>
            </td>
            <td class="py-4 px-4 text-center">
              <% if product.out_of_stock? %>
                <span class="px-2 py-1 bg-red-100 text-red-700 text-xs font-bold rounded-lg">OUT OF STOCK</span>
              <% elsif product.low_stock? %>
                <span class="px-2 py-1 bg-amber-100 text-amber-700 text-xs font-bold rounded-lg">LOW STOCK</span>
              <% else %>
                <span class="px-2 py-1 bg-emerald-100 text-emerald-700 text-xs font-bold rounded-lg">IN STOCK</span>
              <% end %>
            </td>
            <td class="py-4 px-4 text-center">
              <% if product.product_variants.any? %>
                <div class="text-xs space-y-1">
                  <% product.product_variants.limit(3).each do |variant| %>
                    <div class="flex items-center justify-between text-left">
                      <span class="text-slate-600"><%= variant.name || variant.sku %></span>
                      <span class="font-bold ml-2 <%= variant.out_of_stock? ? 'text-red-600' : (variant.low_stock? ? 'text-amber-600' : 'text-emerald-600') %>">
                        <%= variant.stock_quantity %>
                      </span>
                    </div>
                  <% end %>
                  <% if product.product_variants.count > 3 %>
                    <div class="text-slate-400">+<%= product.product_variants.count - 3 %> more</div>
                  <% end %>
                </div>
              <% else %>
                <span class="text-slate-400 text-xs">No variants</span>
              <% end %>
            </td>
            <td class="py-4 px-4 text-right">
              <button onclick="openAdjustModal(<%= product.id %>, '<%= product.name %>', <%= product.stock_quantity %>)" 
                      class="px-3 py-1.5 bg-indigo-600 text-white text-xs font-semibold rounded-lg hover:bg-indigo-700 transition">
                Adjust Stock
              </button>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="mt-4">
    <%= paginate @products %>
  </div>
</div>

<!-- Simple Modal for Stock Adjustment -->
<div id="adjustModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
    <h3 class="text-lg font-bold mb-4">Adjust Stock</h3>
    <%= form_with url: "#", method: :patch, id: "adjustForm", class: "space-y-4" do %>
      <%= hidden_field_tag :authenticity_token, form_authenticity_token, id: 'authenticity_token' %>
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-2">Product</label>
        <div id="modalProductName" class="text-slate-600"></div>
      </div>
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-2">Current Stock</label>
        <div id="modalCurrentStock" class="text-2xl font-bold text-slate-800"></div>
      </div>
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-2">Adjustment Type</label>
        <select name="adjustment_type" class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
          <option value="add">Add Stock</option>
          <option value="subtract">Subtract Stock</option>
          <option value="set">Set Stock</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-2">Quantity</label>
        <input type="number" name="quantity" min="0" class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" required>
      </div>
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-2">Note (Optional)</label>
        <textarea name="note" rows="2" class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
      </div>
      <div class="flex space-x-3">
        <button type="button" onclick="closeAdjustModal()" class="flex-1 px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-semibold hover:bg-slate-200 transition">
          Cancel
        </button>
        <button type="submit" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700 transition">
          Update Stock
        </button>
      </div>
    <% end %>
  </div>
</div>

<script>
function openAdjustModal(productId, productName, currentStock) {
  document.getElementById('modalProductName').textContent = productName;
  document.getElementById('modalCurrentStock').textContent = currentStock;
  document.getElementById('adjustForm').action = `/admin/inventory/${productId}/update_stock`;
  document.getElementById('adjustModal').classList.remove('hidden');
}

function closeAdjustModal() {
  document.getElementById('adjustModal').classList.add('hidden');
}
</script>
